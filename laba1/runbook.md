## Before start

Перед запуском рекомендую прочитать файлик task.md, там написано задание, которое здесь выполнялось, также перед стартом вам необходимо иметь 2 виртуальные машины с доступом по ssh ключу, на них будет находится вся конфигурация для корректной отработки ansible.

Как я написал ранее, вам нужно иметь 2 ВМ и ключи для них, инфу про них нужно будет указать в файле inventory.ini, там указаны мои данные (как пример).

После того, как вы все указали, нужно для начала установить основные компоненты и ресурсы, путем расскоментирования первых двух модулей в файле /task/main.yaml для обоих машин и запустить плейбук.
```bash
# - import_tasks: install.yaml

# - import_tasks: prepare-disk.yaml
```

## Start playbook
```bash
cd laba1
ansible-playbook -i inventory.ini deploy.yaml
```

После запуска в терминале вы увидите логи по установке postgresql, добавление конфигациионных файлов и монтирования каталога /pg_data/16 для дальнейшей инициализации бд.

## Create DB

Мы подготовили наши две машины, теперь необходимо перейти на первую ВМ (postgres-master) и ручками зайти под пользователем postgres, создать базу и пользователя под нее для нагрузочного тестирования (pg_bench). Для ознакомления что такое pgbench и зачем он нужен https://habr.com/ru/companies/tantor/articles/914320/
Код с базой находится в файлике db.txt, достаточно подключиться к машине, на ней к пользователю postgres и через утилиту psql создать базу.

После того как мы создали базу и пользователя под нее, необходимо подключиться и проверить права доступа, на всякий случай. 

## Load testing and logging

После создания базы можно переходить к следующим пунктам, а это настройка логирования, и проведение нагрузочного тестирования путем раскоментирования следующих модулей в /task/main в postgres-master, два первых модуля лучше закоментировать, так как мы уже провели первоначальную настройку ВМ. Также **для удобства в файлике deploy.yaml лучше на время законментировать postgres-slave так как он нам пока не нужен.**

```bash
# setup postgres, up initdb
# - import_tasks: setup.yaml

#- import_tasks: configure-logging.yaml

# pgbench configuration
#- import_tasks: pgbench.yaml
```

После проведения нагрузочного тестирования на машине (postgres-master) появится файлик с логами, где можно будет подробно ознакомится с выполнением таски:

Файлик находится по данному пути:
```bash
/pg_data/16/log/postgresql-Thu.log 

#также если не хотите замарачиваться можно провести нагрузочное тестирование командой, до этого обязательно подключившись к машине:
PGPASSWORD=1234 pgbench -h localhost -p 5432 -U pgbench -c 10 -j 4 -T 60 bench
```

## Replication
Мы сделали тестирование, получили какие-то результаты, можно приступить к репликации, опять же закоментируйте модули, которые были использованы и раскоментируйте самый последний модуль с тасками для репликации. В них создается пользователь replicator и настраивается доступ для другой ВМ.

Для корректной работы и скорости необхдимо раскоментировать в postgres-slave строчку с - import_tasks: physical-rep.yaml и раскоментировать роль postgres-slave в deplo.yaml. После того как мы настроили запуск, можем стартовать плейбук, дефолтной командой.

```bash
ansible-playbook -i inventory.ini deploy.yaml
```

Проверку правильной репликации и в целом как посмотреть результат я описал в отдельном файле (check-replication.md).






